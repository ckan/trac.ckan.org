<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  


  <head>
    <title>
      #1083 (userobjectroles added twice can't be deleted)
     â€“ CKAN
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!--[if IE]><script type="text/javascript">window.location.hash = window.location.hash;</script><![endif]-->
        <link rel="search" href="../search.html" />
        <link rel="prev" href="1082.html" title="Ticket #1082" />
        <link rel="last" href="3030.html" title="Ticket #3030" />
        <link rel="help" href="../wiki/TracGuide.html" />
        <link rel="alternate" href="1083%3Fformat=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="1083%3Fformat=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="1083%3Fformat=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="1084.html" title="Ticket #1084" />
        <link rel="start" href="../wiki.1.html" />
        <link rel="stylesheet" href="../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../chrome/common/css/ticket.css" type="text/css" />
        <link rel="first" href="1.html" title="Ticket #1" />
        <link rel="shortcut icon" href="../chrome/common/trac.ico" type="image/x-icon" />
        <link rel="icon" href="../chrome/common/trac.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="../search/opensearch" title="Search CKAN" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="93d81ccf9a7bb1c456462f62";
    </script>
    <script type="text/javascript" src="../chrome/common/js/jquery.js"></script><script type="text/javascript" src="../chrome/common/js/babel.js"></script><script type="text/javascript" src="../chrome/common/js/messages/en_US.js"></script><script type="text/javascript" src="../chrome/common/js/trac.js"></script><script type="text/javascript" src="../chrome/common/js/search.js"></script><script type="text/javascript" src="../chrome/common/js/folding.js"></script><script type="text/javascript" src="../chrome/common/js/wikitoolbar.js"></script><script type="text/javascript" src="../chrome/common/js/resizer.js"></script><script type="text/javascript" src="../chrome/common/js/auto_preview.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
        var args = {realm: "ticket", id: 1083, escape_newlines: 0}
        $("#comment").autoPreview("/wiki_render", args, function(textarea, text, rendered) {
            $("#ticketchange div.comment").html(rendered);
            if (rendered)
              $("#ticketchange").show();
            else if ($("#ticketchange ul.changes").length == 0)
              $("#ticketchange").hide();
        });
        $("#trac-comment-editor textarea").autoPreview("/wiki_render", args,
                                                       function(textarea, text, rendered) {
          var comment = $("#trac-comment-editor").next("div.comment");
          comment.html(rendered);
          if (rendered)
            comment.show();
          else
            comment.hide();
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="http://ckan.org/"><img src="http://assets.okfn.org/p/ckan/img/ckan_logo_shortname.png" alt="CKAN Trac" height="70" /></a>
      </div>
      <form id="search" action="../search.html" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="../login.html">Login</a></li><li><a href="../prefs.html">Preferences</a></li><li><a href="../wiki/TracGuide.html">Help/Guide</a></li><li><a href="../about.html">About Trac</a></li><li class="last"><a href="../register.html">Register</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="../timeline.html">Timeline</a></li><li><a href="../roadmap.html">Roadmap</a></li><li class="active"><a href="../report.html">View Tickets</a></li><li><a href="../search.html">Search</a></li><li class="last"><a href="../wiki.1.html">Wiki</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
              <li class="first"><span>&larr; <a class="prev" href="1082.html" title="Ticket #1082">Previous Ticket</a></span></li><li class="last"><span><a class="next" href="1084.html" title="Ticket #1084">Next Ticket</a> &rarr;</span></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="1083.html">Ticket #1083</a>
          <span class="status">(closed defect: fixed)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened <a class="timeline" href="../timeline%3Ffrom=2011-04-11T19:37:40Z&amp;precision=second.html" title="2011-04-11T19:37:40Z in Timeline">3 years</a> ago</p>
    <p>Last modified <a class="timeline" href="../timeline%3Ffrom=2011-05-16T09:23:47Z&amp;precision=second.html" title="2011-05-16T09:23:47Z in Timeline">3 years</a> ago</p>
  </div>
  <h2 class="summary searchable">userobjectroles added twice can't be deleted</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        <a href="../query%3Fstatus=!closed&amp;reporter=johnlawrenceaspden.html">johnlawrenceaspden</a>
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        <a href="../query%3Fstatus=!closed&amp;owner=johnlawrenceaspden.html">johnlawrenceaspden</a>
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="../query%3Fstatus=!closed&amp;priority=awaiting+triage.html">awaiting triage</a>
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="closed milestone" href="../milestone/ckan-v1.5-sprint-1.html">ckan-v1.5-sprint-1</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="../query%3Fstatus=!closed&amp;component=ckan.html">ckan</a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
        <th id="h_repo">
          Repository:
        </th>
        <td headers="h_repo">
              <a href="../query%3Fstatus=!closed&amp;repo=ckan.html">ckan</a>
        </td>
    </tr><tr>
        <th id="h_theme">
          Theme:
        </th>
        <td headers="h_theme">
              <a href="../query%3Fstatus=!closed&amp;theme=none.html">none</a>
        </td>
        <th>
        </th>
        <td>
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
the add_user_to_role/remove_user_from_role functions are asymmetrical
in that the add function is happy to add the same role twice but the remove asserts that it's only in the table once and crashes if that's not true.
</p>
<p>
an attempt has been made to guard against this, but fails, I think because the add functions rely on the caller committing the change to the db.
</p>
<p>
same problem affects corresponding authorization_group functions
</p>
<p>
I'll try to sort this out. Making a note here.
</p>

    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="1083.html#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-04-11T19:37:56Z&amp;precision=second.html" title="2011-04-11T19:37:56Z in Timeline">3 years</a> ago by johnlawrenceaspden
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Owner</strong>
        set to <em>johnlawrenceaspden</em>
    </li><li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>assigned</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="1083.html#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-05-09T09:50:43Z&amp;precision=second.html" title="2011-05-09T09:50:43Z in Timeline">3 years</a> ago by johnlawrenceaspden
                </h3>
                
  <ul class="changes">
    <li>
      <strong>state</strong>
        set to <em>draft</em>
    </li><li>
      <strong>Milestone</strong>
        set to <em>ckan-v1.5-sprint-1</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="1083.html#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-05-09T21:14:41Z&amp;precision=second.html" title="2011-05-09T21:14:41Z in Timeline">3 years</a> ago by johnlawrenceaspden
                </h3>
                
    <div class="comment searchable">
      
      <p>
Current behaviour:
</p>
<p>
from the web interface, russianfan can be added as an admin on warandpeace twice.
and you can then delete the two roles separately.
desired behaviour is that you can only add him once.
</p>
<p>
from the command line, you can only add him once, but if he's in there twice, you can't remove him because the command line bombs
desired behaviour is that he can be removed
</p>
<p>
from the shell, you can add him twice but can't remove him if he's been added twice.
if you try, it bombs.
</p>
<p>
The desired behaviour in all cases is that adding and removing are effective and idempotent in all three cases.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="1083.html#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-05-10T18:11:01Z&amp;precision=second.html" title="2011-05-10T18:11:01Z in Timeline">3 years</a> ago by johnlawrenceaspden
                </h3>
                
    <div class="comment searchable">
      
      <p>
It appears to be possible to get into a state where you can't add or remove roles from the command line. Investigating.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-5">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:5" class="cnum">
      <a href="1083.html#comment:5">comment:5</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-05-10T20:17:01Z&amp;precision=second.html" title="2011-05-10T20:17:01Z in Timeline">3 years</a> ago by johnlawrenceaspden
                </h3>
                
    <div class="comment searchable">
      
      <p>
Fixed the problem where you can't delete a role if it's been added twice, but had to leave the add function as it was since putting a commit in it breaks many tests.
</p>
<p>
It appears that the WUI doesn't call these functions anyway. Left that as it is since we're planning to replace it.
</p>
<p>
The cli rights command doesn't appear to add the roles that it says it adds. Possibly because it's not doing the required commit? Reported this as a different bug.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-6">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:6" class="cnum">
      <a href="1083.html#comment:6">comment:6</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-05-16T09:23:47Z&amp;precision=second.html" title="2011-05-16T09:23:47Z in Timeline">3 years</a> ago by johnlawrenceaspden
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>assigned</em> to <em>closed</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="../wiki/TracTickets.html">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="1083%3Fformat=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="1083%3Fformat=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="1083%3Fformat=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="../about.html"><strong>Trac 0.12.3</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the Trac open source project at<br /><a href="http://trac.edgewall.org/">http://trac.edgewall.org/</a></p>
    </div>
  </body>
</html>