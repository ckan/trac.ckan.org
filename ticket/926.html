<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  


  <head>
    <title>
      #926 (Pick a simpler form framework)
     – CKAN
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!--[if IE]><script type="text/javascript">window.location.hash = window.location.hash;</script><![endif]-->
        <link rel="search" href="../search.html" />
        <link rel="prev" href="925.html" title="Ticket #925" />
        <link rel="last" href="3030.html" title="Ticket #3030" />
        <link rel="help" href="../wiki/TracGuide.html" />
        <link rel="alternate" href="926%3Fformat=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="926%3Fformat=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="926%3Fformat=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="927.html" title="Ticket #927" />
        <link rel="start" href="../wiki.1.html" />
        <link rel="stylesheet" href="../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../chrome/common/css/ticket.css" type="text/css" />
        <link rel="first" href="1.html" title="Ticket #1" />
        <link rel="shortcut icon" href="../chrome/common/trac.ico" type="image/x-icon" />
        <link rel="icon" href="../chrome/common/trac.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="../search/opensearch" title="Search CKAN" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="93d81ccf9a7bb1c456462f62";
    </script>
    <script type="text/javascript" src="../chrome/common/js/jquery.js"></script><script type="text/javascript" src="../chrome/common/js/babel.js"></script><script type="text/javascript" src="../chrome/common/js/messages/en_US.js"></script><script type="text/javascript" src="../chrome/common/js/trac.js"></script><script type="text/javascript" src="../chrome/common/js/search.js"></script><script type="text/javascript" src="../chrome/common/js/folding.js"></script><script type="text/javascript" src="../chrome/common/js/wikitoolbar.js"></script><script type="text/javascript" src="../chrome/common/js/resizer.js"></script><script type="text/javascript" src="../chrome/common/js/auto_preview.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
        var args = {realm: "ticket", id: 926, escape_newlines: 0}
        $("#comment").autoPreview("/wiki_render", args, function(textarea, text, rendered) {
            $("#ticketchange div.comment").html(rendered);
            if (rendered)
              $("#ticketchange").show();
            else if ($("#ticketchange ul.changes").length == 0)
              $("#ticketchange").hide();
        });
        $("#trac-comment-editor textarea").autoPreview("/wiki_render", args,
                                                       function(textarea, text, rendered) {
          var comment = $("#trac-comment-editor").next("div.comment");
          comment.html(rendered);
          if (rendered)
            comment.show();
          else
            comment.hide();
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="http://ckan.org/"><img src="http://assets.okfn.org/p/ckan/img/ckan_logo_shortname.png" alt="CKAN Trac" height="70" /></a>
      </div>
      <form id="search" action="../search.html" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="../login.html">Login</a></li><li><a href="../prefs.html">Preferences</a></li><li><a href="../wiki/TracGuide.html">Help/Guide</a></li><li><a href="../about.html">About Trac</a></li><li class="last"><a href="../register.html">Register</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="../timeline.html">Timeline</a></li><li><a href="../roadmap.html">Roadmap</a></li><li class="active"><a href="../report.html">View Tickets</a></li><li><a href="../search.html">Search</a></li><li class="last"><a href="../wiki.1.html">Wiki</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
              <li class="first"><span>&larr; <a class="prev" href="925.html" title="Ticket #925">Previous Ticket</a></span></li><li class="last"><span><a class="next" href="927.html" title="Ticket #927">Next Ticket</a> &rarr;</span></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="926.html">Ticket #926</a>
          <span class="status">(closed enhancement: fixed)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened <a class="timeline" href="../timeline%3Ffrom=2011-01-24T11:37:36Z&amp;precision=second.html" title="2011-01-24T11:37:36Z in Timeline">3 years</a> ago</p>
    <p>Last modified <a class="timeline" href="../timeline%3Ffrom=2011-02-24T09:59:57Z&amp;precision=second.html" title="2011-02-24T09:59:57Z in Timeline">3 years</a> ago</p>
  </div>
  <h2 class="summary searchable">Pick a simpler form framework</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        <a href="../query%3Fstatus=!closed&amp;reporter=sebbacon.html">sebbacon</a>
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        <a href="../query%3Fstatus=!closed&amp;owner=sebbacon.html">sebbacon</a>
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="../query%3Fstatus=!closed&amp;priority=critical.html">critical</a>
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="closed milestone" href="../milestone/ckan-v1.4-sprint-1.html">ckan-v1.4-sprint-1</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="../query%3Fstatus=!closed&amp;component=ckan.html">ckan</a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
              <a href="../query%3Fstatus=!closed&amp;keywords=~forms.html">forms</a>
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
        <th id="h_repo">
          Repository:
        </th>
        <td headers="h_repo">
              <a href="../query%3Fstatus=!closed.html"></a>
        </td>
    </tr><tr>
        <th id="h_theme">
          Theme:
        </th>
        <td headers="h_theme">
              <a href="../query%3Fstatus=!closed.html"></a>
        </td>
        <th>
        </th>
        <td>
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
      <span class="lastmod" title="2011-02-07 09:11:24+00:00">
        (last modified by rgrp)
        (<a href="926%3Faction=diff&amp;version=2.html">diff</a>)
      </span>
    </h3>
    <div class="searchable">
      <p>
The current formalchemy setup conflates view, controller and model code in a way that makes it hard to debug and customise.
</p>
<p>
Review existing (and potentially non-existing) frameworks with a view to porting forms over to something more explicit and lightweight.
</p>
<p>
Implement the current Package forms as an example of how this would work.
</p>
<p>
Document and circulate.
</p>
<p>
Sub-ticket of <a class="closed ticket" href="961.html" title="enhancement: [super] Refactoring of forms, validation and model synchronization (closed: fixed)">#961</a> (form, validation, model sync meta-ticket)
</p>

    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="926.html#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-02-02T09:12:07Z&amp;precision=second.html" title="2011-02-02T09:12:07Z in Timeline">3 years</a> ago by rgrp
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Priority</strong>
        changed from <em>awaiting triage</em> to <em>critical</em>
    </li><li>
      <strong>Milestone</strong>
        set to <em>ckan-v1.4-sprint-1</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Comments from RP - <a class="ext-link" href="http://lists.okfn.org/pipermail/ckan-dev/2011-January/000181.html"><span class="icon">​</span>http://lists.okfn.org/pipermail/ckan-dev/2011-January/000181.html</a>
</p>
<p>
Libraries I have used: <a class="missing wiki">FormEncode?</a>, <a class="missing wiki">FormAlchemy?</a> (what we are currently
using, before that formencode).
</p>
<p>
Neither seemed perfect but I think the form issue is a 'hard' problem
(perhaps with no perfect answer) <a class="missing changeset" title="No default repository defined">[1]</a>. <a class="missing wiki">FormAlchemy?</a>, in retrospect, was
probably a mistake as it merges too much model/validation/form
generation into one thing.
</p>
<p>
At least 3 functions involved:
</p>
<ol><li>Generating (or just filling) a form template with 'form data' (and errors)
</li><li>Converting model data to form data (also happens for APIs in fact) -- let's call this 'dict-ization'
</li><li>Converting form data to model data (and validating) (inverse of
</li></ol><p>
previous step)
</p>
<p>
I think one can and should separate 1 from 2+3 (and one of problems
with formalchemy is it doesn't -- the attraction being you don't
repeat yourself as forms get generated from model but I think this is
actually a false economy in medium-term).
</p>
<p>
I'm not specifically recommending the following as I haven't used them
but I've looked through docs, they are active and reasonably mature:
</p>
<ol><li>Flatland: <a class="ext-link" href="http://discorporate.us/projects/flatland/docs/tip/"><span class="icon">​</span>http://discorporate.us/projects/flatland/docs/tip/</a>
<ul><li>Only does 2+3 which is a good thing IMO
</li></ul></li></ol><ol start="2"><li>WTForms: <a class="ext-link" href="http://wtforms.simplecodes.com/"><span class="icon">​</span>http://wtforms.simplecodes.com/</a>
<ul><li>Used in standard flask docs: &lt;<a class="ext-link" href="http://flask.pocoo.org/docs/patterns/wtforms/"><span class="icon">​</span>http://flask.pocoo.org/docs/patterns/wtforms/</a>&gt;
</li></ul></li></ol>
    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="926.html#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-02-07T09:11:24Z&amp;precision=second.html" title="2011-02-07T09:11:24Z in Timeline">3 years</a> ago by rgrp
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Description</strong>
        modified (<a href="926%3Faction=diff&amp;version=2.html">diff</a>)
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="926.html#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-02-23T19:31:57Z&amp;precision=second.html" title="2011-02-23T19:31:57Z in Timeline">3 years</a> ago by rgrp
                </h3>
                
    <div class="comment searchable">
      
      <p>
@Seb: I believe this is now decided following discussion last week. Please could you detail results and close :)
</p>

    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="926.html#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-02-24T09:59:57Z&amp;precision=second.html" title="2011-02-24T09:59:57Z in Timeline">3 years</a> ago by anonymous
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>closed</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Goals: 
</p>
<p>
We want the interface for updating an object to be loosely coupled to
</p>
<blockquote>
<p>
the method for updating it.
</p>
</blockquote>
<p>
We might update a Package from:
</p>
<ul><li>HTML forms
</li><li>a REST API (using JSON)
</li><li>a CLI (potentially using command line arguments, YaML, XML or ini files)
</li></ul><p>
Right now, data is validated using a form framework, even if we're not
using forms.  Data is written to the object as part of the forms
framework (using the "sync()" method), making the process hard to
customise and hard to discover.
</p>
<p>
Instead, there should be a standard chain for:
</p>
<ul><li>deserialising untyped data (such as that received from an HTTP POST
or parsed from a YaML file) into valid data
</li><li>returning structured errors suitable for displaying to the user
</li><li>saving the validated, deserialised data
</li></ul><p>
Ideally, it would look something like:
</p>
<blockquote>
<p>
schema = <a class="missing wiki">MySchemaDefinition?</a>()
raw_data = open("raw.csv", "r").read()
structured_data = to_python(raw_data, schema)
try:
</p>
<blockquote>
<p>
validated = validate(python_data)
myobject.update_from_dict(validated)
return "Updated OK"
</p>
</blockquote>
<p>
except <a class="missing wiki">ValidationError?</a>, e:
</p>
<blockquote>
<p>
return "Error: %s" % e.to_dict()
</p>
</blockquote>
</blockquote>
<p>
The inverse would be something like:
 
</p>
<blockquote>
<p>
structured_data = myobject.render_to_dict()
raw_data.write(to_csv(structured_data, schema)
print "Wrote CSV %s" % to_logformat(serialized_data, schema)
</p>
</blockquote>
<p>
The question of how to generate and display forms should be completely
decoupled from this.  It should be easy to write forms by hand, which
means it should be simple to flatten the serialized data to key, value
pairs, and match up any validation errors to each key.
</p>
<p>
Optionally, a form widget generation framework is a nice-to-have, but
not essential, as it is expected that, given enough time, the majority
of forms will require manual coding to accomodate edge conditions.
</p>
<p>
A form widget generation framework should be reasonably complete if
it's worth trying at all, which means it should support things like:
</p>
<ul><li>nested fields (at least repeating, multi-value fieldsets)
</li><li>widgets for dates and file uploads
</li><li>internationalisation
</li></ul><p>
...but note I'd settle for *no* widget generation
</p>
<p>
Components of a serialisation / validation framework:
</p>
<ul><li>a simple, obvious way to define a schema
</li><li>a lightweight validation implementation
<ul><li>simple interface for validators
</li><li>easy to match validation errors to data structure items
</li></ul></li></ul><p>
Overall, I'd like to see:
</p>
<ul><li>loose coupling, no framework dependencies
</li><li>maximal test coverage
</li><li>extensive documentation with readily available examples
</li></ul><p>
## Findings
</p>
<p>
I looked at flatland, formencode, <a class="missing wiki">FormAlchemy?</a>, formish, WTForms, Django, web2py, deform/colander, formconvert and web.py
</p>
<ul><li><strong>web2py</strong> just helps build HTML from python, so isn't what I'm after at all 
</li><li><strong>web.py</strong> has rudimentary validation which is only aimed at HTML forms and is hence tightly coupled with them. 
</li><li><strong>Django</strong>'s forms are again tightly coupled to HTML forms (and their generation)
</li><li><strong><a class="missing wiki">FormAlchemy?</a></strong> similarly couples validation to forms, and is focussed on inferring a schema from a data model SQLAlchemy.  
</li><li><strong>WTForms</strong> again focuses on Form generation and don't make itx easy to deserialise arbitrary data
</li></ul><p>
This leaves us with Flatland, Formencode, Formish, <a class="missing wiki">Colander/Peppercorn/Deform?</a>, and <a class="missing wiki">FormConvert?</a>.
</p>
<p>
Having reviewed all of these, I rejected Formencode on the basis of its patchy documentation and relatively low unit test coverage.  I also found it mixed concerns a bit much for my taste.
</p>
<p>
Formish felt similarly sparsely documented.
</p>
<p>
Of the remainder, I'd be happy using any of them, but opted for Colander in the end as it has the most exhaustive documentation and unit tests and has been used in production for a long time.  <a class="missing wiki">FormConvert?</a> has a nice design but is a bit of a moving target at the moment -- worth revisiting in the future.
</p>

    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="../wiki/TracTickets.html">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="926%3Fformat=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="926%3Fformat=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="926%3Fformat=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="../about.html"><strong>Trac 0.12.3</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the Trac open source project at<br /><a href="http://trac.edgewall.org/">http://trac.edgewall.org/</a></p>
    </div>
  </body>
</html>