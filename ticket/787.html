<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  


  <head>
    <title>
      #787 (Auth API)
     â€“ CKAN
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!--[if IE]><script type="text/javascript">window.location.hash = window.location.hash;</script><![endif]-->
        <link rel="search" href="../search.html" />
        <link rel="prev" href="786.html" title="Ticket #786" />
        <link rel="last" href="3030.html" title="Ticket #3030" />
        <link rel="help" href="../wiki/TracGuide.html" />
        <link rel="alternate" href="787%3Fformat=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="787%3Fformat=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="787%3Fformat=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="788.html" title="Ticket #788" />
        <link rel="start" href="../wiki.1.html" />
        <link rel="stylesheet" href="../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../chrome/common/css/ticket.css" type="text/css" />
        <link rel="first" href="1.html" title="Ticket #1" />
        <link rel="shortcut icon" href="../chrome/common/trac.ico" type="image/x-icon" />
        <link rel="icon" href="../chrome/common/trac.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="../search/opensearch" title="Search CKAN" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="93d81ccf9a7bb1c456462f62";
    </script>
    <script type="text/javascript" src="../chrome/common/js/jquery.js"></script><script type="text/javascript" src="../chrome/common/js/babel.js"></script><script type="text/javascript" src="../chrome/common/js/messages/en_US.js"></script><script type="text/javascript" src="../chrome/common/js/trac.js"></script><script type="text/javascript" src="../chrome/common/js/search.js"></script><script type="text/javascript" src="../chrome/common/js/folding.js"></script><script type="text/javascript" src="../chrome/common/js/wikitoolbar.js"></script><script type="text/javascript" src="../chrome/common/js/resizer.js"></script><script type="text/javascript" src="../chrome/common/js/auto_preview.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
        var args = {realm: "ticket", id: 787, escape_newlines: 0}
        $("#comment").autoPreview("/wiki_render", args, function(textarea, text, rendered) {
            $("#ticketchange div.comment").html(rendered);
            if (rendered)
              $("#ticketchange").show();
            else if ($("#ticketchange ul.changes").length == 0)
              $("#ticketchange").hide();
        });
        $("#trac-comment-editor textarea").autoPreview("/wiki_render", args,
                                                       function(textarea, text, rendered) {
          var comment = $("#trac-comment-editor").next("div.comment");
          comment.html(rendered);
          if (rendered)
            comment.show();
          else
            comment.hide();
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="http://ckan.org/"><img src="http://assets.okfn.org/p/ckan/img/ckan_logo_shortname.png" alt="CKAN Trac" height="70" /></a>
      </div>
      <form id="search" action="../search.html" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="../login.html">Login</a></li><li><a href="../prefs.html">Preferences</a></li><li><a href="../wiki/TracGuide.html">Help/Guide</a></li><li><a href="../about.html">About Trac</a></li><li class="last"><a href="../register.html">Register</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="../timeline.html">Timeline</a></li><li><a href="../roadmap.html">Roadmap</a></li><li class="active"><a href="../report.html">View Tickets</a></li><li><a href="../search.html">Search</a></li><li class="last"><a href="../wiki.1.html">Wiki</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
              <li class="first"><span>&larr; <a class="prev" href="786.html" title="Ticket #786">Previous Ticket</a></span></li><li class="last"><span><a class="next" href="788.html" title="Ticket #788">Next Ticket</a> &rarr;</span></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="787.html">Ticket #787</a>
          <span class="status">(closed task: fixed)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened <a class="timeline" href="../timeline%3Ffrom=2010-11-08T10:10:35Z&amp;precision=second.html" title="2010-11-08T10:10:35Z in Timeline">3 years</a> ago</p>
    <p>Last modified <a class="timeline" href="../timeline%3Ffrom=2011-09-12T09:51:58Z&amp;precision=second.html" title="2011-09-12T09:51:58Z in Timeline">3 years</a> ago</p>
  </div>
  <h2 class="summary searchable">Auth API</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        <a href="../query%3Fstatus=!closed&amp;reporter=thejimmyg.html">thejimmyg</a>
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        <a href="../query%3Fstatus=!closed&amp;owner=thejimmyg.html">thejimmyg</a>
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="../query%3Fstatus=!closed&amp;priority=major.html">major</a>
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="closed milestone" href="../milestone/ckan-sprint-2011-09-12.html">ckan-sprint-2011-09-12</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="../query%3Fstatus=!closed&amp;component=dgu.html">dgu</a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
              <a href="../query%3Fstatus=!closed&amp;keywords=~dgu.html">dgu</a>
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
        <th id="h_repo">
          Repository:
        </th>
        <td headers="h_repo">
              <a href="../query%3Fstatus=!closed&amp;repo=ckan.html">ckan</a>
        </td>
    </tr><tr>
        <th id="h_theme">
          Theme:
        </th>
        <td headers="h_theme">
              <a href="../query%3Fstatus=!closed&amp;theme=none.html">none</a>
        </td>
        <th>
        </th>
        <td>
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
Auth Proposal
</p>
<p>
Use case: We'd like an authenticated and authorized Drupal user to be able to
edit/delete packages using the API
</p>
<p>
To do this a user would need a CKAN API key so we need some way of Drupal
telling CKAN who a user is so that they can get their API key.
</p>
<p>
Proposed Implementation
</p>
<hr />
<p>
A user visits the CKAN API key page to get their key. Because CKAN is at
catalogue.data.gov.uk (a subdomain of the Drupal site) it can read Drupal
cookies.
</p>
<p>
If there is no <tt></tt>DRXtrArgs<tt></tt> or <tt></tt>DRXtrArgs2<tt></tt> cookie, we know the user isn't
signed in so we redirect them to Drupal to sign in.
</p>
<p>
WISHLIST: It would be really nice if we could pass the URL to redirect back to
Drupal so tha Druapl can send them back to the CKAN API key page
</p>
<p>
Either way, they get back to CKAN and now the cookies exist. When the first
HTTP request header is sent, CKAN will read the Drupal session ID and then call
a Drupal API, server to server.
</p>
<p>
TODO: Implement an API on the drupal server which accepts a Drupal session ID
as an argument and returns the username and credentials, but only if the
request if from the CKAN server (perhaps we specify an API key in the request)
</p>
<p>
If the session is valid CKAN will set its own auth cookie and show them the
page with the API key. CKAN only considers a user signed in if both the CKAN
cookie *and* Drupal session ID are present. If at any time they sign out of
Drupal the Drupal session disappears so they will be signed out of CKAN too.
</p>
<p>
Now the user has an API key they can use the standard CKAN command line API
tools.
</p>
<p>
The API key is the only thing the user will need to use the CKAN API. This
poses a problem. What if a user is removed from Drupal but still has a CKAN API
key?
</p>
<p>
Two solutions:
</p>
<ol><li>API keys will be set to only be valid for the length of a Drupal session so
that a user will only be able to use the write API for a little time after
credentials are revoked
</li></ol><ol start="2"><li>CKAN provides an API to allow Drupal to revoke keys
</li></ol><p>
Option 1. seems easier to me. If we choose this we will write a <tt></tt>get_api_key<tt></tt>
command line tool so that Drupal user can write things like this:
</p>
<p>
::
</p>
<blockquote>
<p>
datapkg list_packages --api_key <tt>get_api_key</tt>
</p>
</blockquote>
<p>
 
The <tt></tt>get_api_key<tt></tt> function will prompt for username and password and then
perform the steps necessary to get an API key.
</p>

    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="787.html#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2010-11-09T09:33:27Z&amp;precision=second.html" title="2010-11-09T09:33:27Z in Timeline">3 years</a> ago by pudo
                </h3>
                
    <div class="comment searchable">
      
      <p>
Alternative:
</p>
<ul><li>The Drupal system will expose a resource at data.gov.uk/profile which wil contain the reqesting user's nickname, fullname, email etc. in JSON (or XML) form. 
</li><li>The Drupal system will also run an OAuth server (and provide /request_token, /access_token, /authorize). 
</li><li>CKAN's login form will be rewired to initiate a client OAuth request on the /profile resource.
</li><li>Recognizing CKAN's callback URL at catalogue.data.gov.uk, Drupal will automatically grant the request if a user is signed in. 
</li><li>Upon return, a user is created, optionally using the OAuth access token as the users API key, thus making it known both to Drupal and CKAN. 
</li><li>The authorizer will be extended to check access to the /profile resource for OAuth accounts (slow but safe). 
</li></ul><p>
Advantages: 
</p>
<ul><li>Well-known protocol, does not depend on cookies (which are strange and never behave as defined, or even the same in multiple browsers) 
</li><li>Python code is available: <a class="ext-link" href="http://oauth.googlecode.com/svn/code/python/oauth/example"><span class="icon">â€‹</span>http://oauth.googlecode.com/svn/code/python/oauth/example</a>
</li><li>Drupal seems to have very complete support: <a class="ext-link" href="http://drupal.org/node/296205"><span class="icon">â€‹</span>http://drupal.org/node/296205</a> 
</li><li>Can be fully implemented as a plugin, using an OAuthClientController for callback and adding hooks to the Authorizer (perhaps need to reconfigure who.ini)
</li></ul>
    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="787.html#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2010-11-15T10:07:38Z&amp;precision=second.html" title="2010-11-15T10:07:38Z in Timeline">3 years</a> ago by johnbywater
                </h3>
                
  <ul class="changes">
    <li>
      <strong>sprint</strong>
        changed from <em>1.3.3</em> to <em>1.3.4</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Moved from sprint 1.3.3
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="787.html#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-01-07T16:32:46Z&amp;precision=second.html" title="2011-01-07T16:32:46Z in Timeline">3 years</a> ago by thejimmyg
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Priority</strong>
        set to <em>major</em>
    </li><li>
      <strong>Component</strong>
        set to <em>dgu</em>
    </li><li>
      <strong>Milestone</strong>
        changed from <em>ckan-v1.3</em> to <em>longterm</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="787.html#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-03-28T09:47:47Z&amp;precision=second.html" title="2011-03-28T09:47:47Z in Timeline">3 years</a> ago by thejimmyg
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Repository</strong>
        set to <em>ckan</em>
    </li><li>
      <strong>Theme</strong>
        set to <em>none</em>
    </li><li>
      <strong>Milestone</strong>
        changed from <em>longterm</em> to <em>ckan-v1.4-sprint-5</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-5">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:5" class="cnum">
      <a href="787.html#comment:5">comment:5</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-04-18T09:14:14Z&amp;precision=second.html" title="2011-04-18T09:14:14Z in Timeline">3 years</a> ago by thejimmyg
                </h3>
                
    <div class="comment searchable">
      
      <p>
The AuthAPI now exists as an IMiddleware plugin, we really need the permission system moved into CKAN before it is useful though and this depends on a refactor of the Auth system. See <a class="closed ticket" href="1094.html" title="enhancement: [super] Refactor the Auth System (closed: duplicate)">#1094</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-6">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:6" class="cnum">
      <a href="787.html#comment:6">comment:6</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-04-18T09:14:43Z&amp;precision=second.html" title="2011-04-18T09:14:43Z in Timeline">3 years</a> ago by thejimmyg
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Milestone</strong>
        changed from <em>ckan-v1.4-sprint-5</em> to <em>ckan-v1.4-sprint-6</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-7">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:7" class="cnum">
      <a href="787.html#comment:7">comment:7</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-07-08T12:00:48Z&amp;precision=second.html" title="2011-07-08T12:00:48Z in Timeline">3 years</a> ago by shevski
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Milestone</strong>
        changed from <em>ckan-v1.5</em> to <em>ckan-current-sprint</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-8">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:8" class="cnum">
      <a href="787.html#comment:8">comment:8</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-08-15T09:23:03Z&amp;precision=second.html" title="2011-08-15T09:23:03Z in Timeline">3 years</a> ago by kindly
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Keywords</strong>
        <em>dgu</em> added
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-9">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:9" class="cnum">
      <a href="787.html#comment:9">comment:9</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="../timeline%3Ffrom=2011-09-12T09:51:58Z&amp;precision=second.html" title="2011-09-12T09:51:58Z in Timeline">3 years</a> ago by thejimmyg
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>closed</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li><li>
      <strong>Milestone</strong>
        changed from <em>ckan-current-sprint</em> to <em>ckan-sprint-2011-09-12</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
The joint authentication was implemented a long time ago and is deployed on catalogue.data.gov.uk. We'll build the authorisation layer in ticket <a class="new ticket" href="1326.html" title="enhancement: Write a set of auth plugin functions to integrate with Druapl (new)">#1326</a> so marking this as fixed.
</p>

    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="../wiki/TracTickets.html">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="787%3Fformat=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="787%3Fformat=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="787%3Fformat=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="../about.html"><strong>Trac 0.12.3</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the Trac open source project at<br /><a href="http://trac.edgewall.org/">http://trac.edgewall.org/</a></p>
    </div>
  </body>
</html>